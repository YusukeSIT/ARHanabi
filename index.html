<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" charset="utf-8">
		<link rel="stylesheet" href="./data/style.css" type="text/css">
		<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
		<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
		
		<!--  花火のアニメーション再生に必要  -->
		<script src="./data/aframe-particleplayer-component.js"></script>
		<script>
		AFRAME.registerComponent('cursor-listener', {
    		init: function () {
				this.el.addEventListener('raycaster-intersected', evt => {
	   		     	this.raycaster = evt.detail.el;
	   		    });
   		   		this.el.addEventListener('raycaster-intersected-cleared', evt => {
   		     		this.raycaster = null;
   		   		});
  		  	},

  		  	// 毎フレームの処理
  		  	tick: function () {
				if (!this.raycaster) { return; }  // Not intersecting.
				let intersection = this.raycaster.components.raycaster.getIntersection(this.el).point;
				if (!intersection) { return; } // Not intersecting
				// 箱の座標を衝突点にセット
				intersection.y += 0.5;
				new_gltf_model.setAttribute('position', intersection);
				//new_box.setAttribute('rotation', cam.getAttribute('rotation'));
			}	
 		});

		</script>


	</head>

	<!--ズームなどの一部動作の制限-->
	<body style="touch-action:none">

		<!--iOSにおいてDeviceMotion取得するために、ユーザーに画面タッチを強制-->
		<div id="ui" class="permission_ui">
			<p id="discription" class="permission_ui center_ui">画面をタッチしてください</p>
		</div>

		<!--3D空間-->
		
		<!--
		permission_uiを優先するために初期状態では表示しない
		device-orientation-permission-uiをfalseにすることでa-frameにデフォルトで搭載されているDeviceMotion取得用UIを無視
		embedded arjsでarモードを有効化
		vr-mode-uiをfalseにすることで右下の謎のボタンを削除(Androidだとできてない？)
		id="main"は今のところ意味なし
		physicallyCorrectLight: falseはthreeの旧バージョンのライトの使用を宣言
		-->
		<a-scene id="main" device-orientation-permission-ui="enabled: false" embedded arjs vr-mode-ui="enabled: false;" style="display: none; position: static;" renderer="physicallyCorrectLights: false">
			<a-entity id='camera' camera look-controls="touchEnabled: false;" wasd-controls position="0 8 0"></a-entity>
				
				<!--移動オブジェクトの移動先の取得-->
			<a-entity cursor="rayOrigin: mouse" raycaster="objects: #target;"></a-entity> 

			<!--rayの衝突用-->
			<a-plane cursor-listener id="target" rotation = "-90 0 0" position="0 0 0" scale="500 500 1" opacity = "0"></a-plane>

			<!--花火アニメーション読み込み-->
			<a-assets>
				<a-asset-item id="particlesJson" src="./data/fireworks_test.json"></a-asset-item>
				<img src="./data/sprite.png" id="particleTex">
			</a-assets>

			<a-entity position="0 1 -5" trigger particleplayer="on: particleplayerstart; src: #particlesJson; img: #particleTex; dur: 4000; count: 75%; scale: 0.3; pscale: 1; interpolate: true; shader: standard; poolSize: 20"></a-entity>
					
		</a-scene>


		<!--  FIRE!!!!!!  -->
		<input type = "button" id = "b1" value = "打ち上げ" onclick = "tenka();" style="display:none">
		
		<!--仮UI-->


		<!--JS用-->
		<script>
		var pNumber = 7;
		var pipes = [];
		var childs = [];
		var waiting = true;

		for (let i = 0; i < pNumber; i++) {

			new_gltf_model = document.createElement('a-gltf-model');
			new_gltf_model.setAttribute('id', 'i');
			//new_gltf_model.setAttribute('dynamic-body', 'shape: cube; mass: 1');
			new_gltf_model.setAttribute('scale', '0.6 0.6 0.6');
			new_gltf_model.setAttribute('position', '0 0 0');
			new_gltf_model.setAttribute('src', '#model-tube');

			pipes.push(new_gltf_model);


			let pos = pipes[i].getAttribute('position');
			pos.x = Math.random() * 25 - 12.5;
			pos.y = 0;
			pos.z = Math.random() * -25 - 5;
			pipes[i].setAttribute('position', pos);
			pipes[i].setAttribute('id', i);
			document.querySelector('a-scene').appendChild(pipes[i]);

			let bool = true;
			childs.push(bool);
		}


		AFRAME.registerComponent('box-colider', {
			tick: function () {
				let pos = this.el.getAttribute('position');
				for (let i = 0; i < pNumber; i++) {

					let p = pipes[i].getAttribute('position');

					p.x = pos.x - 0.03 + (0.38 * i);
					p.y = pos.y;
					p.z = pos.z - 0.01;
					pipes[i].setAttribute('position', p);

				}
			}
		});
 		AFRAME.registerComponent('trigger', {
		  	init: function() {
			    document.addEventListener('click', () => {
			        this.trigger();
			    },
			    {
			    	once: true
			    });
		  	},

		 	trigger: function() {

				let ranNum = Math.floor(Math.random() * pNumber);
				let ranWait = Math.random() * 1500;
				let x = pipes[ranNum].getAttribute('position').x - 0.38*3;
				let y = pipes[ranNum].getAttribute('position').y + 14.6;
				let z = pipes[ranNum].getAttribute('position').z;
				console.log("x:" + x + ", y:" + y + ", z:" + z);

			    this.el.emit('particleplayerstart', {
			      position: new THREE.Vector3(
			        x,
			        y + Math.random() * 2,
			      ),
			      rotation: new THREE.Euler(Math.random() * 1 - .5, 0, 0)
			    });

				setTimeout(() => {this.trigger()}, ranWait);
		  	}
		});

		</script>
		<script src="./data/tsts.js"></script>
	</body>
</html>